{% extends "layout.html" %}
{% block title %}Institute Reports{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-6">
   <!-- Download Button -->
  <div class="mb-6">
    <a href="/reports?download=1"
       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md transition">
      ğŸ“¥ Download Analytics HTML
    </a>
  </div>

  <h1 class="text-3xl font-bold mb-8">ğŸ“Š Institute Analytics Dashboard</h1>

  <!-- Top Stat Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">

    <!-- Active Students -->
    <div class="bg-white shadow-lg rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-gray-600">Active Students</h2>
        <span class="text-blue-500 text-xl">ğŸ‘¥</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mt-3">{{ total_students }}</p>
      <p class="mt-2 text-sm {% if student_growth_percent >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
        {% if student_growth_percent >= 0 %}
          ğŸ“ˆ +{{ student_growth_percent }}% from last month
        {% else %}
          ğŸ“‰ {{ student_growth_percent }}% from last month
        {% endif %}
      </p>
    </div>

    <!-- Active Faculty -->
    <div class="bg-white shadow-lg rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-gray-600">Active Faculty</h2>
        <span class="text-purple-500 text-xl">ğŸ‘¨â€ğŸ«</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mt-3">{{ active_faculty }}</p>
    </div>

    <!-- Tests Conducted -->
    <div class="bg-white shadow-lg rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-gray-600">Tests Conducted</h2>
        <span class="text-orange-500 text-xl">ğŸ“</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mt-3">{{ total_test }}</p>
    </div>

    <!-- Monthly Revenue -->
    <div class="bg-white shadow-lg rounded-2xl p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-gray-600">Monthly Revenue</h2>
        <span class="text-green-500 text-xl">ğŸ’²</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mt-3">â‚¹ {{ monthly_revenue }}</p>
      <p class="mt-2 text-sm {% if revenue_growth_percent >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
        {% if revenue_growth_percent >= 0 %}
          ğŸ“ˆ +{{ revenue_growth_percent }}% from last month
        {% else %}
          ğŸ“‰ {{ revenue_growth_percent }}% from last month
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Analytics Section -->
 <!-- Analytics Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

  <!-- Left Column: Top Performers Summary -->
  <div class="p-6 mt-10">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ† Top Performers</h2>
    <p class="text-gray-500 mb-6">Students with highest scores from the latest completed tests</p>

    <div class="space-y-4">
      {% for performer in top_performers %}
      <div class="bg-white shadow-md rounded-xl p-4 flex justify-between items-center">
        <div class="flex flex-col">
          <span class="text-lg font-bold text-blue-700">{{ performer.student_name }}</span>
          <span class="text-gray-500 text-sm">{{ performer.course_name }}</span>
          <span class="text-gray-600 text-sm">Test: {{ performer.test_title }}</span>
        </div>

        <div class="text-right flex flex-col items-end">
          <span class="text-purple-600 font-semibold text-xl">{{ performer.percentage }}%</span>
          <span class="text-gray-500 text-sm">Score: {{ performer.marks_obtained }} / {{ performer.total_marks }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Right Column: Button -->
    <div class="flex flex-col justify-center items-center bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-2xl shadow-xl p-10">
      <h2 class="text-xl font-bold mb-3">ğŸ“Š View Course Performance</h2>
      <p class="text-blue-100 mb-6 text-center">Check detailed top 3 students per test and filter by course & month.</p>
      <a href="/course-performance" class="bg-white text-blue-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-100 transition">
        Go to Course Performance
      </a>
    </div>

</div>

</div>

<div class="p-6 bg-white rounded-2xl shadow-md">
  <h2 class="text-xl font-bold flex items-center gap-2 mb-1">
    <span class="text-green-600 text-2xl">ğŸ’²</span> Payment Analysis
  </h2>
  <p class="text-gray-500 text-sm mb-6">Fee collection status and financial overview</p>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    {% for status, data in payment_summary.items() %}
      {% set color =
        "green" if status == "Paid"
        else "yellow" if status == "Partial"
        else "purple" if status == "Pay Later"
        else "red"
      %}

      {# ---- Format Paid Amount ---- #}
      {% if data.paid_amount >= 100000 %}
        {% set paid_display = data.paid_amount // 100000 ~ 'L' %}
      {% elif data.paid_amount >= 1000 %}
        {% set paid_display = data.paid_amount // 1000 ~ 'K' %}
      {% else %}
        {% set paid_display = data.paid_amount %}
      {% endif %}

      {# ---- Student Progress ---- #}
      {% set student_percent = (data.students / total_students * 100) if total_students > 0 else 0 %}

      <!-- Card -->
      <div class="bg-{{ color }}-50 rounded-2xl p-4 shadow-sm">
        <!-- Status Tag -->
        <span class="bg-{{ color }}-100 text-{{ color }}-700 text-xs font-semibold px-2 py-1 rounded-full">
          {{ status }}
        </span>

        <!-- Students Count -->
        <p class="text-3xl font-bold text-gray-800 mt-2">{{ data.students }}</p>
        <p class="text-sm text-gray-500 mb-2">Students</p>

        <!-- Total Paid Amount -->
        <p class="text-lg font-semibold text-green-600">
          â‚¹{{ paid_display }}
        </p>

        <!-- Progress Bar for Students -->
        <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
          <div class="bg-{{ color }}-500 h-2 rounded-full" style="width: {{ student_percent }}%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-1">{{ student_percent | round(0) }}% of total students</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Monthly Trends UI like Screenshot -->
<div class="p-6 mt-10">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">ğŸ“… Monthly Trends</h2>
  <p class="text-gray-500 mb-6">Growth trends over the past 4 months</p>

  <div class="space-y-4">
    {% for item in monthly_summary %}
    <div class="flex justify-between items-center p-6 rounded-xl shadow-md bg-gradient-to-r from-blue-50 to-purple-50">
      <div class="flex flex-col">
        <!-- Month -->
        <span class="text-blue-600 font-bold text-lg mb-1">{{ item.month }}</span>
        <span class="text-gray-600 text-sm">Monthly performance summary</span>
      </div>

      <!-- Students -->
      <div class="text-center">
        <span class="text-blue-700 font-semibold text-xl block">{{ item.students }}</span>
        <span class="text-gray-500 text-sm">Students</span>
      </div>

      <!-- Revenue -->
<div class="text-center">
  {% if item.revenue == 0 %}
    <span class="text-red-600 font-semibold text-xl block">â‚¹0</span>
    <span class="text-gray-500 text-sm">No Revenue</span>
  {% else %}
    {% if item.revenue < 100000 %}
      {% set revenue_display = '%.1fK' % (item.revenue / 1000) %}
    {% else %}
      {% set revenue_display = '%.2fL' % (item.revenue / 100000) %}
    {% endif %}
    <span class="text-green-600 font-semibold text-xl block">â‚¹{{ revenue_display }}</span>
    <span class="text-gray-500 text-sm">Revenue</span>
  {% endif %}
</div>
      <!-- Tests -->
      <div class="text-center">
        <span class="text-purple-600 font-semibold text-xl block">{{ item.tests }}</span>
        <span class="text-gray-500 text-sm">Tests</span>
      </div>
    </div>
    {% endfor %}
  </div>
</div>


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Student Growth Chart
  const studentCtx = document.getElementById('studentGrowthChart').getContext('2d');
  new Chart(studentCtx, {
      type: 'line',
      data: {
          labels: {{ monthly_labels | safe }},
          datasets: [{
              label: 'New Students',
              data: {{ monthly_counts | safe }},
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3
          }]
      },
      options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
      }
  });

  // Revenue Growth Chart
  const revenueCtx = document.getElementById('revenueGrowthChart').getContext('2d');
  new Chart(revenueCtx, {
      type: 'bar',
      data: {
          labels: {{ revenue_labels | safe }},  // ["Jan", "Feb", ...]
          datasets: [{
              label: 'Revenue',
              data: {{ revenue_values | safe }},  // [5000, 7000, ...]
              backgroundColor: 'rgba(16, 185, 129, 0.6)',
              borderColor: 'rgba(5, 150, 105, 1)',
              borderWidth: 2
          }]
      },
      options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
      }
  });
</script>

{% endblock %}
